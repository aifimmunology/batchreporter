<!-- # Child Rmarkdown Document for scrna metadata formatting -->
<!-- Reads in metadata from labeled h5 file, adds back in metadata from multiplets -->
<!-- Parent document must have a variable "rna_in_dir" containing a subfolder "labeled_h5" -->

```{r rna_metadata_files}
if(!exists("all_labeled_h5")){
  all_labeled_h5 <- list.files(path = file.path(rna_in_dir,"labeled_h5"), pattern = "_labeled.h5$", full.names = TRUE, recursive = TRUE)
  stm(paste0("IN Labeled H5 Files  :\n\t", paste(all_labeled_h5, collapse = "\n\t")))
}

if(!exists("all_multiplet_h5")){
  all_multiplet_h5 <- list.files(path = file.path(rna_in_dir,"multiplet_h5"), pattern = "_multiplet.h5$", full.names = TRUE, recursive = TRUE)
  stm(paste0("IN Multiplet H5 Files:\n\t", paste(all_multiplet_h5, collapse = "\n\t")))
}

```

```{r merge_meta}
# Merge Metadata
stm("Reading in labeled h5 file meta data")

# Merge the count matrices for all samples into 1 table
avail_workers <- as.numeric(future::availableCores())
suppressWarnings(future::plan("multiprocess", workers = avail_workers))

meta_list <- future_lapply(all_labeled_h5, read_h5_cell_meta)
meta <- do.call(rbind, meta_list)
setDT(meta)

remove("meta_list")
```

```{r read_multiplet}  
# Create meta data table that includes missing hashes and multiplet data
stm("Reading in multiplet h5 file meta data")
multiplet_meta_list <- future_lapply(all_multiplet_h5, read_h5_cell_meta)
multiplet_meta <- do.call(rbind, multiplet_meta_list)
setDT(multiplet_meta)
all_meta <- merge(meta, multiplet_meta, all = TRUE) 
remove("multiplet_meta_list","multiplet_meta")
```  
  
```{r add_vars_meta }
meta[, ":="(fct_mito_umi = n_mito_umis/n_umis)]
meta[, ":="(fct_mito_umi_binary = ifelse(fct_mito_umi > fct_mito_umi_threshold,
                                         paste0(">",fct_mito_umi_threshold),
                                         paste0("<=",fct_mito_umi_threshold)))]
meta[ , sample_pool:= sprintf("%s_%s", get(sample_column_name), pool_id)]
meta[ , plot_barcode:= sprintf("%s\n%s", hto_barcode, sample_pool)]


all_meta[, ":="(fct_mito_umi = n_mito_umis/n_umis)]
all_meta[, ":="(fct_mito_umi_binary = ifelse(fct_mito_umi > fct_mito_umi_threshold,
                                             paste0(">",fct_mito_umi_threshold),
                                             paste0("<=",fct_mito_umi_threshold)))]
all_meta[ , sample_pool:= sprintf("%s_%s", get(sample_column_name), pool_id)]
all_meta[ , plot_barcode:= sprintf("%s\n%s",hto_barcode, sample_pool)]
all_meta[ , hto_category := factor(hto_category, levels = c("no_hash", "singlet", "doublet", "multiplet"))]

```
