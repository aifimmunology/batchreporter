# scrna-batch-qc
# DRAFT: Needs library update and example update with available data

Scripts for summarizing and performing QC on scRNA seq data generated by the cell hashing pipeline 

<a id="contents"></a>

## Contents

#### [Dependencies](#dependencies)

#### [Summarizing Batch: run_scrna_batch_summary.R](#batch_report)
- [Sample Sheet Guidelines](#sample_sheet)
- [Parameters](#batch_report_param)
- [Outputs](#batch_report_out)
- [Tests](#batch_report_test)

<a id="dependencies"></a>

## Dependencies

This repository requires that `pandoc` and `libhdf5-devel` libraries are installed:
```
sudo apt-get install pandoc libhdf5-devel
```

It also depends on the `H5weaver`, `HTOparser`,`jsonlite`, `rmarkdown`, and `optparse` libraries.

`jsonlite`, `rmarkdown`, and `optparse` are available from CRAN, and can be installed in R using:
```
install.packages("jsonlite")
install.packages("rmarkdown")
install.packages("optparse")
```

`HTOparser` is one of our own packages found in the aifimmunology Github repositories. Because it is a private repository, you may need to provided a [Github Personal Access Token](https://github.com/settings/tokens) for installation:
```
Sys.setenv(GITHUB_PAT = "[your_PAT_here]")
devtools::install_github("aifimmunology/HTOparser")
```

`H5weaver` is also found in the aifimmunology Github repositories. Install with:
```
Sys.setenv(GITHUB_PAT = "[your_PAT_here]")
devtools::install_github("aifimmunology/H5weaver")
```

[Return to Contents](#contents)

<a id="batch_report"></a>

## Running scRNA Seq Batch Report

`scrna-batch-qc` is compatible with results files generated by [`cell-hashing-pipeline`](https://github.com/aifimmunology/cell-hashing-pipeline) and [`cell-labeling-pipeline`](https://github.com/aifimmunology/cell-labeling-pipeline). Output files from both processes are required for processing.

[Return to Contents](#contents)

<a id="hto_parse"></a>

## Interpreting/parsing HTO results

The tools above provide counts for each combination of cell and hash barcode. To convert these from counts to singlet/multiplet calls, these scripts use the [`HTOparser`](https://github.com/aifimmunology/HTOparser) R package, installed with:
```
devtools::install_github("aifimmunology/HTOparser")
```

Once installed, this repository can serve as a bridge to actually run the HTO interpretation, output files, and generate a summary report using the `run_hto_processing.R` wrapper script.

<a id="sample_sheet"></a>

`run-scrna-batch-qc.R` requires a **Sample Sheet**, provided as the -k parameter, which has 5 comma-separated columns: SampleID, BatchID, HashTag, PoolID, and WellID.  
All wells associated with each sample should be collapsed into a ";"-delimited string.  

For example:
```
SampleID,Type,BatchID,HashTag,PoolID,WellID
PB5206W2,Sample,B001,HT1,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB5206W3,Sample,B001,HT2,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB5206W4,Sample,B001,HT3,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB5206W5,Sample,B001,HT4,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB5206W6,Sample,B001,HT5,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB5206W7,Sample,B001,HT6,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W2,Sample,B001,HT7,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W3,Sample,B001,HT8,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W4,Sample,B001,HT9,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W5,Sample,B001,HT10,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W6,Sample,B001,HT12,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
PB7626W7,Sample,B001,HT13,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
IMM19-711,Control,B001,HT14,B001-P1,C1W1;C1W2;C1W3;C1W4;C1W5;C1W6;C1W7;C1W8;C2W1;C2W2;C2W3;C2W4;C2W5
```
<a id="batch_report_param"></a>

If you are running this script without a **Sample Sheet**, the -k parameter can be omitted, which will use a fall-back built into `scrna-batch-qc`.

There are 6 parameters for this script:  

* `-b or --batch_id`:  
* `-i or --in_dir`: The input directory containing the files to process. Should include the following subdirectories:  
  * `labeled_h5`: Contains all sample labeled.h5 files for the batch generated by [`cell-labeling-pipeline`](https://github.com/aifimmunology/cell-labeling-pipeline)  
  * `multiplet`: Contains all pool multiplet.h5 files for the batch generated by `run_h5_merge_by_hash.R` from [`cell-hashing-pipeline`](https://github.com/aifimmunology/cell-hashing-pipeline)  
  * `hash`: Contains all well hto_processing_metrics .json files for the batch generated by `run_hto_processing.R` from [`cell-hashing-pipeline`](https://github.com/aifimmunology/cell-hashing-pipeline)  
  * `control`: Contains all batch control labeled.h5 files generated by [`cell-labeling-pipeline`](https://github.com/aifimmunology/cell-labeling-pipeline) for the previous 10 batches? one per batch? last 10 samples? standard 10 reference files?  
* `-k or --in_key`: A 4-column Sample Sheet (see above).  
* `-d or --out_dir`: A directory path to use to output the HTO Processing results  
* `-o or --out_html`: A filename to use to output the HTML summary report file  


An example run:
```
git clone https://github.com/aifimmunology/scrna-batch-qc.git

Rscript --vanilla \
cell-hashing-pipeline/run_scrna_batch_qc.R \
-b T001 \
-i /shared/lokada/scrna_batchreport_tests/data/test_data \
-k /shared/lokada/scrna_batchreport_tests/data/SampleSheet.csv \
-d /shared/lokada/scrna_batchreport_tests/output/T001/ \
-o /shared/lokada/scrna_batchreport_tests/output/T001/T001_batch_report.html
```

[Return to Contents](#contents)

<a id="batch_report_out"></a>

### Output Files

`run_hto_processing.R` will generate xxxx as well as the HTML reporting file. 

xxx files are named based on BatchID : [BatchID]_xxx.xxx

For example, using the run above, we would get the following outputs in out_dir:
```
T001_xxx.xxx
T001_scrna_batch_report.html
```

[Return to Contents](#contents)

<a id="batch_report_test"></a>

### Tests

Test runs can be performed using datasets provided with the `HTOparser` package using `-t test_cite` or `-t test_awk`. These require only the `-t` and `-o` parameters.

```
Rscript --vanilla \
cell-hashing-pipeline/run_hto_processing.R \
-t test_cite \
-o /shared/lucasg/pipeline_cellhashing_tests/output/test_cite/hto_processing_report.html

Rscript --vanilla \
cell-hashing-pipeline/run_hto_processing.R \
-t test_awk \
-o /shared/lucasg/pipeline_cellhashing_tests/output/test_awk/hto_processing_report.html
```

[Return to Contents](#contents)

